local PlayerGui = game.Players.LocalPlayer:WaitForChild("PlayerGui")
local LocalPlayer = game.Players.LocalPlayer
local Character = LocalPlayer.Character
repeat task.wait() until Character:FindFirstChild("RemoteEvent") and Character:FindFirstChild("RemoteFunction")
local RemoteFunction, RemoteEvent = Character.RemoteFunction, Character.RemoteEvent
local HRP = Character.PrimaryPart

-- НАСТРОЙКИ
getgenv().waitUntilCollect = 0.3
getgenv().teleportDistance = 15
getgenv().teleportDelay = 0.05
getgenv().isFarming = false
getgenv().platformVisible = false

-- ПЕРЕМЕННЫЕ ДЛЯ GUI
local sellSettings = {
    ["Ancient Scroll"] = true,
    ["Caesar's Headband"] = true,
    ["Clackers"] = true,
    ["Diamond"] = true,
    ["Dio's Diary"] = true,
    ["Gold Coin"] = true,
    ["Mysterious Arrow"] = true,
    ["Pure Rokakaka"] = true,
    ["Quinton's Glove"] = true,
    ["Rib Cage of The Saint's Corpse"] = true,
    ["Rokakaka"] = true,
    ["Steel Ball"] = true,
    ["Zeppeli's Hat"] = true,
    ["Stone Mask"] = true
}

-- СОЗДАЕМ ПЛАТФОРМУ ПОД НОГАМИ
local platform = Instance.new("Part")
platform.Name = "AntiFallPlatform"
platform.Size = Vector3.new(10, 1, 10)
platform.Anchored = true
platform.CanCollide = true
platform.Transparency = 1 -- НЕВИДИМАЯ ПЛАТФОРМА
platform.Parent = workspace

-- ФУНКЦИЯ ОБНОВЛЕНИЯ ПЛАТФОРМЫ
local function updatePlatform()
    while true do
        if Character and HRP and getgenv().platformVisible then
            platform.CFrame = CFrame.new(HRP.Position.X, HRP.Position.Y - 5, HRP.Position.Z)
        end
        task.wait(0.1)
    end
end

task.spawn(updatePlatform)

-- АНТИ-АФК
local function antiAFK()
    while true do
        task.wait(30)
        local VirtualUser = game:GetService("VirtualUser")
        VirtualUser:CaptureController()
        VirtualUser:ClickButton2(Vector2.new())
    end
end

task.spawn(antiAFK)

-- ФУНКЦИЯ ДЛЯ ПОИСКА ВСЕХ ПРЕДМЕТОВ НА КАРТЕ С СОРТИРОВКОЙ ПО БЛИЗОСТИ
local function findItem(itemName)
    local ItemsDict = {
        ["Position"] = {},
        ["ProximityPrompt"] = {},
        ["Items"] = {}
    }
    
    local tempItems = {}
    
    for _,item in pairs(game:GetService("Workspace")["Item_Spawns"].Items:GetChildren()) do
        if item:FindFirstChild("MeshPart") and item.ProximityPrompt then
            if item.ProximityPrompt.ObjectText == itemName then
                if item.ProximityPrompt.MaxActivationDistance == 8 then
                    table.insert(tempItems, {
                        Position = item.MeshPart.CFrame,
                        Prompt = item.ProximityPrompt,
                        Distance = (HRP.Position - item.MeshPart.Position).Magnitude
                    })
                end
            end
        end
    end
    
    table.sort(tempItems, function(a, b)
        return a.Distance < b.Distance
    end)
    
    for _, item in ipairs(tempItems) do
        table.insert(ItemsDict["Items"], itemName)
        table.insert(ItemsDict["ProximityPrompt"], item.Prompt)
        table.insert(ItemsDict["Position"], item.Position)
    end
    
    return ItemsDict
end

-- ФУНКЦИЯ ДЛЯ ПОДСЧЕТА КОЛИЧЕСТВА ПРЕДМЕТОВ В ИНВЕНТАРЕ
local function countItems(itemName)
    local itemAmount = 0
    for _,item in pairs(game.Players.LocalPlayer.Backpack:GetChildren()) do
        if item.Name == itemName then
            itemAmount += 1
        end
    end
    return itemAmount
end

-- ФУНКЦИЯ ФОКУСИРОВКИ КАМЕРЫ НА ПРЕДМЕТЕ
local function focusCameraOnItem(itemPosition)
    if not Character:FindFirstChild("FocusCam") then
        local FocusCam = Instance.new("ObjectValue")
        FocusCam.Name = "FocusCam"
        FocusCam.Parent = Character
    end
    
    local focusPart = Instance.new("Part")
    focusPart.Anchored = true
    focusPart.CanCollide = false
    focusPart.Transparency = 1
    focusPart.Size = Vector3.new(1, 1, 1)
    focusPart.CFrame = itemPosition
    focusPart.Parent = workspace
    
    Character.FocusCam.Value = focusPart
    
    return focusPart
end

-- ФУНКЦИЯ ПРОДАЖИ ПРЕДМЕТОВ КОТОРЫХ БОЛЬШЕ 9+
local function sellItemsIfOver9()
    if not getgenv().isFarming then return false end
    
    local itemsToSell = {
        "Ancient Scroll",
        "Caesar's Headband",
        "Clackers",
        "Diamond",
        "Dio's Diary",
        "Gold Coin",
        "Mysterious Arrow",
        "Pure Rokakaka",
        "Quinton's Glove",
        "Rib Cage of The Saint's Corpse",
        "Rokakaka",   
        "Steel Ball",
        "Zeppeli's Hat",
        "Stone Mask"
    }
    
    local soldSomething = false
    
    for _, itemName in pairs(itemsToSell) do
        if sellSettings[itemName] and countItems(itemName) >= 9 then
            local item = LocalPlayer.Backpack:FindFirstChild(itemName)
            if item then
                LocalPlayer.Character.Humanoid:EquipTool(item)
                task.wait(0.3)
                local dialogueToEnd = {
                    ["NPC"] = "Merchant",
                    ["Dialogue"] = "Dialogue5",
                    ["Option"] = "Option2"
                }
                RemoteEvent:FireServer("EndDialogue", dialogueToEnd)
                task.wait(0.3)
                soldSomething = true
            end
        end
    end
    
    return soldSomething
end

-- ТЕЛЕПОРТЫ ПО 15 СТАДОВ СО СКОРОСТЬЮ 0.05
local function fastTeleportToItem(targetCFrame)
    local startPos = HRP.Position
    local targetPos = targetCFrame.Position
    local distance = (targetPos - startPos).Magnitude
    
    local steps = math.ceil(distance / getgenv().teleportDistance)
    for i = 1, steps do
        if not Character or not HRP or not getgenv().isFarming then break end
        local lerpPos = startPos:Lerp(targetPos, i/steps)
        HRP.CFrame = CFrame.new(lerpPos.X, lerpPos.Y + 5, lerpPos.Z)
        if getgenv().platformVisible then
            platform.CFrame = CFrame.new(HRP.Position.X, HRP.Position.Y - 5, HRP.Position.Z)
        end
        if i < steps then
            task.wait(getgenv().teleportDelay)
        end
    end
end

-- ОСНОВНАЯ ФУНКЦИЯ СБОРА ПРЕДМЕТА
local function getitem(item, itemIndex)
    if not getgenv().isFarming then return false end
    
    local gotItem = false
    local startTime = tick()
    local itemName = item["Items"][1]

    if Character:FindFirstChild("SummonedStand") then
        if Character:FindFirstChild("SummonedStand").Value then
            RemoteFunction:InvokeServer("ToggleStand", "Toggle")
        end
    end

    -- Включаем платформу только во время сбора
    getgenv().platformVisible = true

    -- Фокусируем камеру на предмете
    local focusPart = focusCameraOnItem(item["Position"][itemIndex])

    local connection
    connection = LocalPlayer.Backpack.ChildAdded:Connect(function(child)
        if child.Name == itemName then
            gotItem = true
            if connection then connection:Disconnect() end
        end
    end)
    
    fastTeleportToItem(item["Position"][itemIndex])

    task.wait(getgenv().waitUntilCollect)

    fireproximityprompt(item["ProximityPrompt"][itemIndex])
    
    local screenGui = LocalPlayer.PlayerGui:WaitForChild("ScreenGui", 1)
    
    if screenGui then
        local screenGuiPart = screenGui:WaitForChild("Part", 1)
        if screenGuiPart then
            for _, button in pairs(screenGuiPart:GetDescendants()) do
                if button:FindFirstChild("Part") then
                    if button:IsA("ImageButton") and button:WaitForChild("Part").TextColor3 == Color3.new(0, 1, 0) then
                        local clickTime = tick()
                        repeat
                            firesignal(button.MouseButton1Click)
                            task.wait(0.1)
                            if tick() - clickTime > 2 then
                                break
                            end
                        until not LocalPlayer.PlayerGui:FindFirstChild("ScreenGui") or gotItem or not getgenv().isFarming
                        break
                    end
                end
            end
        end
    end
    
    -- Ждем пока не подберем предмет или 3 секунды
    while not gotItem and (tick() - startTime) < 3 and getgenv().isFarming do
        task.wait(0.1)
    end
    
    -- Убираем фокус камеры
    if focusPart then
        focusPart:Destroy()
    end
    if Character:FindFirstChild("FocusCam") then
        Character.FocusCam:Destroy()
    end
    
    if connection then connection:Disconnect() end
    
    -- Выключаем платформу после сбора
    getgenv().platformVisible = false
    
    return gotItem
end

-- ФУНКЦИЯ ФАРМА КОНКРЕТНОГО ПРЕДМЕТА
local function farmItem(itemName)
    if not getgenv().isFarming then return false end
    
    local items = findItem(itemName)
    
    if #items["Position"] == 0 then
        return false
    end

    for itemIndex, _ in pairs(items["Position"]) do
        if not getgenv().isFarming then break end
        getitem(items, itemIndex)
        task.wait(0.2)
    end
    
    return true
end

-- ВСЕ ПРЕДМЕТЫ ДЛЯ ФАРМА
local allItems = {
    "Ancient Scroll",
    "Blue Candy",
    "Caesar's Headband", 
    "Clackers",
    "Diamond",
    "Dio's Diary",
    "Gold Coin",
    "Green Candy",
    "Heart of The Saint's Corpse",
    "Koichi's Suitcase",
    "Left Arm of The Saint's Corpse",
    "Lighter",
    "Mysterious Arrow",
    "Pelvis of The Saint's Corpse",
    "Pure Rokakaka", 
    "Quinton's Glove",
    "Red Candy",
    "Rib Cage of The Saint's Corpse",
    "Rokakaka",
    "Stand Arrow",
    "Steel Ball",
    "Yellow Candy",
    "Zeppeli's Hat",
    "Lucky Arrow",
    "Stone Mask",
    "Lucky Stone Mask"
}

-- СОЗДАНИЕ GUI
local function createGUI()
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "FarmGUI"
    ScreenGui.Parent = PlayerGui
    ScreenGui.ResetOnSpawn = false -- ВАЖНО: GUI не будет пропадать после смерти

    local MainFrame = Instance.new("Frame")
    MainFrame.Size = UDim2.new(0, 400, 0, 500)
    MainFrame.Position = UDim2.new(0, 10, 0, 10)
    MainFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    MainFrame.BorderSizePixel = 0
    MainFrame.Parent = ScreenGui

    local Corner = Instance.new("UICorner")
    Corner.CornerRadius = UDim.new(0, 8)
    Corner.Parent = MainFrame

    local TitleBar = Instance.new("Frame")
    TitleBar.Size = UDim2.new(1, 0, 0, 40) -- Увеличил высоту для надписи
    TitleBar.Position = UDim2.new(0, 0, 0, 0)
    TitleBar.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    TitleBar.Parent = MainFrame

    local TitleCorner = Instance.new("UICorner")
    TitleCorner.CornerRadius = UDim.new(0, 8)
    TitleCorner.Parent = TitleBar

    -- НАДПИСЬ "АВТО ПРОДАЖА" - БОЛЬШАЯ И ПО ЦЕНТРУ СВЕРХУ
    local AutoSellLabel = Instance.new("TextLabel")
    AutoSellLabel.Size = UDim2.new(1, 0, 1, 0)
    AutoSellLabel.Position = UDim2.new(0, 0, 0, 0)
    AutoSellLabel.BackgroundTransparency = 1
    AutoSellLabel.TextColor3 = Color3.fromRGB(255, 255, 255) -- БЕЛЫЙ ЦВЕТ
    AutoSellLabel.Text = "АВТО ПРОДАЖА"
    AutoSellLabel.Font = Enum.Font.GothamBold
    AutoSellLabel.TextSize = 18 -- БОЛЬШЕЙ ШРИФТ
    AutoSellLabel.TextXAlignment = Enum.TextXAlignment.Center -- ПО ЦЕНТРУ
    AutoSellLabel.TextYAlignment = Enum.TextYAlignment.Center
    AutoSellLabel.Parent = TitleBar

    -- КНОПКА СВОРАЧИВАНИЯ
    local MinimizeButton = Instance.new("TextButton")
    MinimizeButton.Size = UDim2.new(0, 25, 0, 25)
    MinimizeButton.Position = UDim2.new(1, -60, 0.5, -12.5)
    MinimizeButton.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
    MinimizeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    MinimizeButton.Text = "-"
    MinimizeButton.Font = Enum.Font.GothamBold
    MinimizeButton.TextSize = 16
    MinimizeButton.Parent = TitleBar

    local MinimizeCorner = Instance.new("UICorner")
    MinimizeCorner.CornerRadius = UDim.new(0, 4)
    MinimizeCorner.Parent = MinimizeButton

    local CloseButton = Instance.new("TextButton")
    CloseButton.Size = UDim2.new(0, 25, 0, 25)
    CloseButton.Position = UDim2.new(1, -30, 0.5, -12.5)
    CloseButton.BackgroundColor3 = Color3.fromRGB(170, 0, 0)
    CloseButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    CloseButton.Text = "X"
    CloseButton.Font = Enum.Font.GothamBold
    CloseButton.TextSize = 14
    CloseButton.Parent = TitleBar

    local CloseCorner = Instance.new("UICorner")
    CloseCorner.CornerRadius = UDim.new(0, 4)
    CloseCorner.Parent = CloseButton

    local ContentFrame = Instance.new("Frame")
    ContentFrame.Size = UDim2.new(1, 0, 1, -40) -- Учитываем новую высоту TitleBar
    ContentFrame.Position = UDim2.new(0, 0, 0, 40)
    ContentFrame.BackgroundTransparency = 1
    ContentFrame.Parent = MainFrame

    local ScrollFrame = Instance.new("ScrollingFrame")
    ScrollFrame.Size = UDim2.new(1, -20, 0, 340)
    ScrollFrame.Position = UDim2.new(0, 10, 0, 10)
    ScrollFrame.BackgroundTransparency = 1
    ScrollFrame.ScrollBarThickness = 6
    ScrollFrame.Parent = ContentFrame

    local UIListLayout = Instance.new("UIListLayout")
    UIListLayout.Padding = UDim.new(0, 5)
    UIListLayout.Parent = ScrollFrame

    -- СОЗДАЕМ ПЕРЕКЛЮЧАТЕЛИ ДЛЯ КАЖДОГО ПРЕДМЕТА
    for itemName, enabled in pairs(sellSettings) do
        local ItemFrame = Instance.new("Frame")
        ItemFrame.Size = UDim2.new(1, 0, 0, 30)
        ItemFrame.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
        ItemFrame.Parent = ScrollFrame

        local ItemCorner = Instance.new("UICorner")
        ItemCorner.CornerRadius = UDim.new(0, 4)
        ItemCorner.Parent = ItemFrame

        local ItemLabel = Instance.new("TextLabel")
        ItemLabel.Size = UDim2.new(0.7, 0, 1, 0)
        ItemLabel.Position = UDim2.new(0, 10, 0, 0)
        ItemLabel.BackgroundTransparency = 1
        ItemLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
        ItemLabel.Text = itemName
        ItemLabel.Font = Enum.Font.Gotham
        ItemLabel.TextSize = 14
        ItemLabel.TextXAlignment = Enum.TextXAlignment.Left
        ItemLabel.Parent = ItemFrame

        local ToggleButton = Instance.new("TextButton")
        ToggleButton.Size = UDim2.new(0, 60, 0, 25)
        ToggleButton.Position = UDim2.new(1, -70, 0.5, -12.5)
        ToggleButton.BackgroundColor3 = enabled and Color3.fromRGB(0, 170, 0) or Color3.fromRGB(170, 0, 0)
        ToggleButton.Text = enabled and "ON" or "OFF"
        ToggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
        ToggleButton.Font = Enum.Font.GothamBold
        ToggleButton.TextSize = 12
        ToggleButton.Parent = ItemFrame

        local ToggleCorner = Instance.new("UICorner")
        ToggleCorner.CornerRadius = UDim.new(0, 4)
        ToggleCorner.Parent = ToggleButton

        ToggleButton.MouseButton1Click:Connect(function()
            sellSettings[itemName] = not sellSettings[itemName]
            ToggleButton.BackgroundColor3 = sellSettings[itemName] and Color3.fromRGB(0, 170, 0) or Color3.fromRGB(170, 0, 0)
            ToggleButton.Text = sellSettings[itemName] and "ON" or "OFF"
        end)
    end

    -- КНОПКИ УПРАВЛЕНИЯ
    local StartButton = Instance.new("TextButton")
    StartButton.Size = UDim2.new(1, -20, 0, 40)
    StartButton.Position = UDim2.new(0, 10, 0, 360)
    StartButton.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
    StartButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    StartButton.Text = "START FARM"
    StartButton.Font = Enum.Font.GothamBold
    StartButton.TextSize = 16
    StartButton.Parent = ContentFrame

    local StartCorner = Instance.new("UICorner")
    StartCorner.CornerRadius = UDim.new(0, 6)
    StartCorner.Parent = StartButton

    local StopButton = Instance.new("TextButton")
    StopButton.Size = UDim2.new(1, -20, 0, 40)
    StopButton.Position = UDim2.new(0, 10, 0, 410)
    StopButton.BackgroundColor3 = Color3.fromRGB(170, 0, 0)
    StopButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    StopButton.Text = "STOP FARM"
    StopButton.Font = Enum.Font.GothamBold
    StopButton.TextSize = 16
    StopButton.Parent = ContentFrame

    local StopCorner = Instance.new("UICorner")
    StopCorner.CornerRadius = UDim.new(0, 6)
    StopCorner.Parent = StopButton

    -- ПЕРЕМЕННЫЕ ДЛЯ ПЕРЕМЕЩЕНИЯ GUI
    local dragging = false
    local dragInput, dragStart, startPos

    -- ФУНКЦИИ ДЛЯ ПЕРЕМЕЩЕНИЯ GUI
    local function updateInput(input)
        local delta = input.Position - dragStart
        MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end

    TitleBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = MainFrame.Position
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)

    TitleBar.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            dragInput = input
        end
    end)

    game:GetService("UserInputService").InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            updateInput(input)
        end
    end)

    -- ПЕРЕМЕННАЯ ДЛЯ СЛЕЖЕНИЯ ЗА СОСТОЯНИЕМ GUI
    local isMinimized = false

    -- ФУНКЦИОНАЛ КНОПКИ СВОРАЧИВАНИЯ
    MinimizeButton.MouseButton1Click:Connect(function()
        if isMinimized then
            -- Разворачиваем
            ContentFrame.Visible = true
            MainFrame.Size = UDim2.new(0, 400, 0, 500)
            MinimizeButton.Text = "-"
            isMinimized = false
        else
            -- Сворачиваем
            ContentFrame.Visible = false
            MainFrame.Size = UDim2.new(0, 400, 0, 40)
            MinimizeButton.Text = "+"
            isMinimized = true
        end
    end)

    -- ФУНКЦИОНАЛ КНОПКИ ЗАКРЫТИЯ
    CloseButton.MouseButton1Click:Connect(function()
        ScreenGui.Enabled = false
    end)

    -- ФУНКЦИОНАЛ КНОПОК СТАРТ/СТОП
    StartButton.MouseButton1Click:Connect(function()
        getgenv().isFarming = true
        StartButton.BackgroundColor3 = Color3.fromRGB(0, 100, 0)
        StopButton.BackgroundColor3 = Color3.fromRGB(170, 0, 0)
    end)

    StopButton.MouseButton1Click:Connect(function()
        getgenv().isFarming = false
        getgenv().platformVisible = false
        StartButton.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
        StopButton.BackgroundColor3 = Color3.fromRGB(100, 0, 0)
    end)

    -- ОБНОВЛЯЕМ РАЗМЕР СКРОЛЛА
    task.wait()
    ScrollFrame.CanvasSize = UDim2.new(0, 0, 0, UIListLayout.AbsoluteContentSize.Y + 10)

    return ScreenGui
end

-- ФУНКЦИЯ ДЛЯ ПЕРЕСОЗДАНИЯ GUI ПРИ СМЕНЕ ПЕРСОНАЖА
local function onCharacterAdded(newCharacter)
    Character = newCharacter
    repeat task.wait() until Character:FindFirstChild("RemoteEvent") and Character:FindFirstChild("RemoteFunction")
    RemoteFunction, RemoteEvent = Character.RemoteFunction, Character.RemoteEvent
    HRP = Character.PrimaryPart
end

LocalPlayer.CharacterAdded:Connect(onCharacterAdded)

-- СОЗДАЕМ GUI
local FarmGUI = createGUI()

-- ОСНОВНОЙ ЦИКЛ ФАРМА
task.wait(2)

while true do
    if not Character or not Character.Parent then
        Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
        repeat task.wait() until Character:FindFirstChild("RemoteEvent") and Character:FindFirstChild("RemoteFunction")
        RemoteFunction, RemoteEvent = Character.RemoteFunction, Character.RemoteEvent
        HRP = Character.PrimaryPart
    end
    
    if getgenv().isFarming then
        for _, itemName in pairs(allItems) do
            if not getgenv().isFarming then break end
            farmItem(itemName)
        end
        
        sellItemsIfOver9()
    end
    
    task.wait(0.3)
end
